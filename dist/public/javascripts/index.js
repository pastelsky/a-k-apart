(function(){function A(a,b,c){var d=new XMLHttpRequest;if(!d)return!1;d.onreadystatechange=function(){4===d.readyState&&200===d.status&&b(c?d.responseText:JSON.parse(d.responseText))};d.open("GET",a);d.send()}function f(a){return document.querySelector(a)}function m(a,b){for(var c=document.querySelectorAll(a),d=0;d<c.length;d++)b(c[d])}function x(a,b,c,d){m(b,function(b){b.addEventListener(a,c,d)})}function l(a,b){m(a,function(a){a.style.display=b||"block"})}function h(a){m(a,function(a){a.style.display=
  "none"})}function p(a,b){m(a,function(a){a.classList.add(b)})}function q(a,b){m(a,function(a){a.classList.remove(b)})}function B(){return"speechSynthesis"in window&&"SpeechSynthesisUtterance"in window}function C(a){a&&this.updatePath(a);this.timer=null}function D(a){a?(l(".nav"),h(".intro"),h(".nav-start"),p(".ship","dock"),p(".story","dock")):(h(".nav"),l(".intro"),l(".nav-start"),q(".ship","dock"),q(".story","dock"),h(".map"),h(".path"))}function t(a,b){var c=f(".story h1"),d=f(".storyboard"),y=
  f(".control-right"),u=f(".control-left"),g=f(".date");f(".ship");f(".map");f(".controls");var m=f(".btn-start"),w=f(".portrait"),v,k,z,e,n=this;this.currentIndex=b||-1;var r=a.timeline;0===this.currentIndex&&(u.disabled=!0);t.setNavigationView=D;t.setNavigationStartView=function(a){var d=function(a){37===a.keyCode?n.prev():39===a.keyCode&&n.next()};a?(l(".nav-start"),h(".heading"),h(".nav-intro"),l(".map"),l(".path"),l(".journey"),q(".story","dock"),p(".wave","speed"),q(".ship","dock"),n.next(),u.disabled=
  !0,x("click",".control-left",function(){n.prev()}),x("click",".control-right",function(){n.next()}),document.addEventListener("keydown",d)):(h(".nav-start"),h(".map"),h(".journey"),l(".nav-intro"),l(".heading"),p(".ship","dock"),p(".story","dock"),q(".wave","speed"),n.prev(),document.removeEventListener("keydown",d))};this.init=function(){c.innerText=a.name;g.innerText=a.lifetime;d.innerText=a.about;m.style.display="block";w.style.backgroundImage='url("'+a.portrait+'")';A(a.path,function(a){document.body.insertAdjacentHTML("beforeend",
  a);t.setNavigationView(!0)},!0);x("click",".btn-start",this.start)};this.start=function(){v=f(".path path");k=f(".path circle");v.getBoundingClientRect();e=new C(v.getAttribute("d"));z=0;e.start(20,n.updatePointer,!1,z,null);t.setNavigationStartView(!0)};this.updatePointer=function(d,b,c){console.log(c);p(".wave","speed");Math.round(c)===a.stops[n.currentIndex]&&(e.stop(),q(".wave","speed"),z=Math.round(c));k.style.transform=k.style.webkitTransform="translate("+d.x+"px,"+d.y+"px) rotate("+b+"deg)"};
  this.next=function(){if(!(this.currentIndex>r.length-2)){this.currentIndex===r.length-2?y.disabled=!0:(y.disabled=!1,u.disabled=!1);var b=r[++this.currentIndex].caption,c=r[this.currentIndex].date;d.innerText=b;g.innerText=c;0!==this.currentIndex&&(console.log("stopping journey and starting at",this.currentIndex,a.stops[this.currentIndex]),e.stop(),e.start(20,n.updatePointer,!1,a.stops[this.currentIndex-1],null));B()}};this.prev=function(){if(!(1>this.currentIndex)){1===this.currentIndex?u.disabled=
    !0:(u.disabled=!1,y.disabled=!1);var b=r[--this.currentIndex].caption,c=r[this.currentIndex].date;d.innerText=b;g.innerText=c;e.start(20,n.updatePointer,!0,a.stops[this.currentIndex+1],null);B()}}}var E=speechSynthesis.getVoices();console.log(E);C.prototype={start:function(a,b,c,d,f,h){this.stop();this.percent=d||0;if(0==a)return!1;var g=this,l=new Date;(function v(){var k=[],m=(new Date-l)/1E3/a,e=100*m;"function"==typeof h&&(e=100*h(m));e=c?d-e:e+d;g.running=!0;if(100<e||0>e)return g.stop(),f.call(g.context);
  g.percent=e;k[0]=g.pointAt(e-1);k[1]=g.pointAt(e+1);k=180*Math.atan2(k[1].y-k[0].y,k[1].x-k[0].x)/Math.PI;g.timer=requestAnimationFrame(v);b.call(g.context,g.pointAt(e),k,g.percent)})()},stop:function(){cancelAnimationFrame(this.timer);this.timer=null;this.running=!1},pointAt:function(a){return this.path.getPointAtLength(this.len*a/100)},updatePath:function(a){this.path=document.createElementNS("http://www.w3.org/2000/svg","path");this.path.setAttribute("d",a);this.len=this.path.getTotalLength()}};
  var w=[{path:"/",onEnter:function(){D(!1)}},{path:"/vasco-da-gama",onEnter:function(){A("/public/data/vasco-da-gama.json",function(a){(new t(a)).init()})}}];(new function(){function a(a){for(var c=0;c<w.length;c++)if(w[c].path===a)return w[c];return null}this.init=function(){var b=a(window.location.pathname),c=this;if(b)b.onEnter();x("click","[data-html5]",function(a){var b=a.target.closest("[data-html5]").getAttribute("href");c.push(b);a.preventDefault()});window.onpopstate=function(){var b=a(window.location.pathname);
    if(b)b.onEnter()}};this.push=function(b){debugger;var c=a(b);history.pushState(null,null,b);console.log("Matched",c);c.onEnter()}}).init()})();
